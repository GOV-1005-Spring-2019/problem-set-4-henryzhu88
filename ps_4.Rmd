---
title: "ps_4"
author: "Henry Zhu"
date: "February 25, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(gt)
library(devtools)
library(tidyverse)
library(readr)
library(janitor)
library(lubridate)
library(knitr)
nc_poll<- read_csv("ps_4_elections-poll-nc09-3.csv")%>%clean_names()
dem<- nc_poll%>%
  filter(response=="Dem")
rep<- nc_poll%>%
  filter(response=="Rep")
und<- nc_poll%>%
  filter(response=="Und")
gendiff<-nc_poll%>% filter(gender!= gender_combined)
whitediff <-nc_poll%>%select(race_eth, file_race_black)%>%filter(race_eth=="White",race_eth!=file_race_black)
reptime<-nc_poll%>%select(response,timestamp)%>%filter(response=="Rep")%>%head(n=1)
demtime<-nc_poll%>%select(response,timestamp)%>%filter(response=="Dem")%>%head(n=1)
bind_cols(reptime,demtime)%>%
  mutate(diffpartytime= interval(timestamp1,timestamp))%>%select(diffpartytime)%>% 
  mutate(diffpartytime_m = diffpartytime %/% minutes(1))
```
There were `r nrow(dem)` respondents who supported the Democratic candidate.

There were `r (nrow(rep)-nrow(und))` more respondents who favored the Republican candidate than who were Undecided.

There are two gender variables (gender and gender_combined). There are `r nrow(gendiff)` individuals for whom these variables have different values.

There are `r nrow(whitediff)` respondents listed as “White” under race_eth who are not listed as “White” under file_race_black.

The first response of Dem came `r bind_cols(reptime,demtime)%>%
  mutate(diffpartytime= interval(timestamp1,timestamp))%>%
  mutate(diffpartytime_m = diffpartytime %/% minutes(1))%>%select(diffpartytime_m)` minutes (rounded to the nearest minute) before the first response of Rep.
  
```{r, include=TRUE, echo=FALSE,results="asis"}
nc_poll %>%
  select(response,race_eth, final_weight) %>%
  mutate(race_eth = fct_relevel(race_eth, "White", "Black", 
                                "Hispanic", "Asian", "Other"))%>%
  group_by(race_eth,response)%>%
  filter(!race_eth=="[DO NOT READ] Don't know/Refused")%>%
  summarize(total = sum(final_weight))%>%
  spread(key =  response, value = total,fill=0)%>%
  mutate(all = Dem + Rep + Und +`3`) %>% 
  mutate(Dem = Dem / all) %>% 
  mutate(Rep = Rep / all) %>% 
  mutate(Und = Und / all)%>%
  select(-all,-`3`)%>%
  ungroup()%>%
gt() %>% 
    tab_header(
      title = "Party Choice by Race", subtitle= "Third Wave, North Carolina’s 9th Congressional District, 2018") %>% 
    tab_source_note("Source: New York Times Upshot/Siena College 2018 live polls")%>%
    
    cols_label(
      race_eth = "Race",
      Dem = "DEM.",
      Rep = "REP.",
      Und = "UND."
      ) %>%
  
    fmt_percent(columns = vars(Dem, Rep, Und),
                decimals = 0) %>% 
    as_raw_html() %>% as.character() %>% cat()
```

```{r, include=TRUE, echo=FALSE}
educ_weight <- nc_poll %>% 
  mutate(educ = fct_relevel(educ,"Grade school","High school","Some college or trade school","Bachelors' degree", "Graduate or Professional Degree")) %>% 
  filter(!educ=="[DO NOT READ] Refused")%>%
  select(educ,final_weight) %>%
ggplot(aes(x =educ, y = final_weight)) + 
  geom_violin()+
  geom_jitter(size=0.9, width=0.2, alpha=0.4)+ 
  coord_flip()+
  labs(title = "More Educated Matters Less in North Carolina 9th",
       subtitle = "Poll gives more weight to people who are less likely to participate in polls",
       caption = "Source: New York Times Upshot/Siena College 2018 live polls") +
  xlab(NULL) +
  ylab("Weight Given to Respondent in Calculating Poll Results")
educ_weight
```

```{r, include=TRUE, echo=FALSE}
agephone<- nc_poll%>% 
  mutate(ager = fct_relevel(ager, "18 to 34", "35 to 49", 
                                "50 to 64", "65 and older"))%>%
  select(ager,phone_type)%>%
  group_by(ager,phone_type)%>% 
  filter(!ager=="[DO NOT READ] Refused")%>%
  summarize(N = n()) %>%
  mutate(freq = N / sum(N),
         pct = round((freq*100), 2))%>%
  ggplot(aes(x = ager, y = pct, fill = phone_type))+
  geom_col(position = "dodge2") +
  labs(x = "Age",y = "Percentage of Respondents", title = "Poll Respondent Phone Type in NC 9th, by Age ",
       subtitle = "A higher proportion of older respondents answered through landlines",
       caption = "Source: New York Times Upshot/Siena College 2018 live polls") +
  theme(legend.position = "top")
agephone
```
